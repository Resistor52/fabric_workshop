ONE-SENTENCE-SUMMARY: This report details a multi-stage attack targeting Elasticsearch servers that deploys the BillGates/Setag backdoor, enabling DDoS attacks and system information theft.

OVERVIEW:
*   The malware is a multi-stage attack that targets Elasticsearch servers.
*   It exploits the CVE-2015-1427 vulnerability in the Groovy scripting engine.
*   The attack uses a crafted search query with encoded Java commands to download malicious scripts.
*   The first-stage script shuts down firewalls and competing crypto-mining activities.
*   The second-stage script removes files, kills processes and downloads the final binary.
*   The final payload is the BillGates/Setag backdoor, capable of DDoS attacks and system information theft.
*   The malware replaces system tools and establishes persistence via init scripts.
*   The malware is detected as ELF_SETAG.SM by Trend Micro.

POTENTIAL IOCs:
*   Hashes (SHA-256):
    *   8ebd963f86ba62f45b936f6d6687ccb1e349a0f8a6cc19286457895c885695c8 (.pprt)
    *   cfe3dccf9ba5a17e410e8e7cf8d0ff5c1b8688f99881b53933006250b6421468 (.ppol)
*   Domains/URLs:
    *   hxxps://crazydavesslots[.]com/[.]ppol
    *   hxxp://aduidc[.]xyz
*   IP Address:
    *   154.223.159.5 (used in the wget command)
*   File paths:
    *   /usr/bin/dpkgd
    *   /etc/rc{1-5}.d/S97DbSecuritySpt
    *   /etc/rc{1-5}.d/S99selinux
    *   /etc/init.d/selinux
    *   /etc/init.d/DbSecuritySpt
    *   /tmp

ATT&CK:
*   Initial Access:
    *   T1190 - Exploit Public-Facing Application (Exploiting CVE-2015-1427 in Elasticsearch)
*   Execution:
    *   T1059.004 - Command and Scripting Interpreter: Unix Shell (Use of shell scripts s67.sh and s66.sh)
    *   T1053.005 - Scheduled Task/Job: Scheduled Task (Persistence via init scripts)
*   Persistence:
    *   T1543.002 - Create or Modify System Process: Systemd Service (Persistence via init scripts)
*   Defense Evasion:
    *   T1070.001 - Indicator Removal on Host: Clear Command History (Removal of initial infection traces)
    *   T1027 - Obfuscated Files or Information (URL encoding)
*   Command and Control:
    *   T1071.001 - Application Layer Protocol: Web Protocols (Downloading scripts via HTTP/HTTPS)
*   Impact:
    *   T1499.001 - Endpoint Denial of Service:  (DDoS capabilities of the backdoor)
    *   T1490 - Inhibit System Recovery (Removal of system files and killing processes)
*   Discovery:
    *   T1082 - System Information Discovery (Stealing system information)
*  Privilege Escalation:
    * T1068 - Exploitation for Privilege Escalation (Exploiting CVE-2015-1427)

POTENTIAL PIVOTS:
*   The IP address 154.223.159.5 could be used to find other malicious activities.
*   The domains crazydavesslots[.]com and aduidc[.]xyz could be investigated for related infrastructure.
*   The hashes of the ELF_SETAG.SM samples can be used to find other samples of the malware.
*   The specific paths where the malware achieves persistence can be used to identify compromised systems.
*   Look for other systems vulnerable to CVE-2015-1427.
*   The use of compromised websites for hosting malware should be monitored.

DETECTION:
*   Monitor network traffic for connections to the identified domains and IP addresses.
*   Implement detection rules for the specific file hashes.
*   Monitor for unusual processes being spawned from Elasticsearch.
*   Look for modifications to init scripts and system tools in the specified paths.
*   Detect the exploitation of CVE-2015-1427 in Elasticsearch.
*   Behavioral analysis to detect the killing of processes and firewall shutdown attempts.

SUGGESTED YARA RULE:
```
rule ELF_SETAG_SM
{
    meta:
        author = "Malware Analyst"
        description = "Detects ELF_SETAG.SM backdoor"
        date = "2024-05-15"
        reference = "https://www.trendmicro.com/en_us/research/19/g/multistage-attack-delivers-billgates-setag-backdoor-can-turn-elasticsearch-databases-into-ddos-botnet-zombies.html"
    strings:
        $str1 = "/usr/bin/dpkgd"
        $str2 = "/etc/rc"
        $str3 = "S97DbSecuritySpt"
        $str4 = "S99selinux"
        $str5 = "/etc/init.d/selinux"
        $str6 = "/etc/init.d/DbSecuritySpt"
        $str7 = "wget"
        $str8 = "curl"
    condition:
        uint16(0) == 0x457f and
        all of ($str*)
}
```

ADDITIONAL REFERENCES:
*   CVE-2015-1427: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-1427
*   CVE-2017-5638: https://www.trendmicro.com/en_us/research/17/c/cve-2017-5638-apache-struts-vulnerability-remote-code-execution.html
*   BillGates botnet: https://www.akamai.com/kr/ko/multimedia/documents/state-of-the-internet/bill-gates-botnet-threat-advisory.pdf
*   Trend Micro's ELF_SETAG.SM description: https://www.trendmicro.com/vinfo/tmr/?/us/threat-encyclopedia/malware/elf_setag.sm

RECOMMENDATIONS:
*   Patch Elasticsearch servers against CVE-2015-1427.
*   Implement network segmentation to limit the impact of compromised systems.
*   Use intrusion prevention systems to block malicious network traffic.
*   Monitor systems for unusual process execution and file modifications.
*   Regularly review system configurations to prevent misconfigurations.
*   Use a security solution with web/URL filtering, behavioral analysis, and sandboxing capabilities.
*   Implement strong access control policies for Elasticsearch servers.
*   Harden systems to prevent malware persistence and execution.

